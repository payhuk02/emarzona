-- =========================================================
-- Migration : Correction Cron Job avec Service Role Key Directe
-- Date : 30 Janvier 2025
-- Description : Utilise la service role key directement pour résoudre les erreurs 401
-- =========================================================

-- ⚠️ ATTENTION : Cette migration utilise la service role key directement
-- En production, considérez utiliser un secret ou une variable d'environnement

-- Supprimer l'ancien cron job
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM cron.job WHERE jobname = 'process-scheduled-email-campaigns'
  ) THEN
    PERFORM cron.unschedule('process-scheduled-email-campaigns');
  END IF;
END $$;

-- Recréer le cron job avec la service role key directement
SELECT cron.schedule(
  'process-scheduled-email-campaigns',
  '0,5,10,15,20,25,30,35,40,45,50,55 * * * *',  -- Toutes les 5 minutes
  $$
  SELECT net.http_post(
    url := 'https://hbdnzajbyjakdhuavrvb.supabase.co/functions/v1/process-scheduled-campaigns',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZG56YWpieWpha2RodWF2cnZiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzU5ODIzMSwiZXhwIjoyMDczMTc0MjMxfQ.MT2e4tcw_5eK0fRQFN5tF1Cwu210MKFUAUGqmYm_1XE',
      'x-cron-secret', 'process-scheduled-campaigns-secret-2025'
    ),
    body := jsonb_build_object('limit', 10)
  ) AS request_id;
  $$
);

-- Vérification
SELECT 
  jobid,
  jobname,
  schedule,
  active,
  LEFT(command, 200) as command_preview
FROM cron.job
WHERE jobname = 'process-scheduled-email-campaigns';


